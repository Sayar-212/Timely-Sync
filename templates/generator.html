<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Generator - Timelyâ„¢</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Times New Roman', serif;
            overflow-x: hidden;
            background: linear-gradient(135deg, #0d1117 0%, #1a1f2e 50%, #2d1b69 100%);
            color: #e6e6e6;
            min-height: 100vh;
        }
        
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: radial-gradient(circle at 50% 50%, rgba(212, 175, 55, 0.02) 0%, transparent 70%);
            pointer-events: none;
            z-index: -1;
        }
        
        .navbar {
            position: fixed;
            top: 0;
            width: 100%;
            padding: 20px 0;
            background: rgba(13, 17, 23, 0.95);
            z-index: 1000;
            border-bottom: 1px solid rgba(212, 175, 55, 0.2);
        }
        
        .nav-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 15px;
            font-size: 1.5rem;
            font-weight: 700;
            color: #d4af37;
        }
        
        .logo img {
            height: 40px;
            width: auto;
            filter: brightness(1.2) contrast(1.1);
        }
        
        .logo img {
            height: 32px;
            width: auto;
        }
        
        .nav-links {
            display: flex;
            gap: 30px;
            list-style: none;
        }
        
        .nav-links a {
            color: rgba(255, 255, 255, 0.8);
            text-decoration: none;
            font-weight: 500;
            transition: color 0.3s ease;
        }
        
        .nav-links a:hover {
            color: #d4af37;
            text-shadow: 0 0 10px rgba(212, 175, 55, 0.5);
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 120px 40px 40px;
            display: grid;
            grid-template-columns: 1fr 400px;
            gap: 40px;
        }
        
        .main-content {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 40px;
            transition: transform 0.3s ease, border-color 0.3s ease;
        }
        
        .main-content:hover {
            transform: translateY(-4px);
            border-color: #d4af37;
        }
        
        .sidebar {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 30px;
            transition: transform 0.3s ease, border-color 0.3s ease;
            height: fit-content;
        }
        
        .sidebar:hover {
            transform: translateY(-4px);
            border-color: #d4af37;
        }
        
        .page-title {
            font-size: clamp(2.5rem, 5vw, 3.5rem);
            font-weight: 400;
            color: #f4f4f4;
            letter-spacing: 3px;
            text-shadow: 0 0 20px rgba(212, 175, 55, 0.6), 2px 2px 4px rgba(0,0,0,0.8);
            margin-bottom: 20px;
        }
        
        .page-subtitle {
            font-size: 1.3rem;
            opacity: 0.8;
            margin-bottom: 40px;
            line-height: 1.6;
            color: #d4af37;
            font-style: italic;
            letter-spacing: 2px;
        }
        
        .form-group { 
            margin-bottom: 30px; 
        }
        
        label { 
            display: block; 
            margin-bottom: 12px; 
            font-weight: 600; 
            color: #d4af37;
            font-size: 1.1rem;
        }
        
        textarea { 
            width: 100%; 
            min-height: 300px; 
            padding: 25px; 
            background: rgba(0, 0, 0, 0.3);
            border: 2px solid rgba(212, 175, 55, 0.3); 
            border-radius: 12px; 
            font-size: 14px; 
            resize: vertical;
            font-family: 'Monaco', 'Menlo', monospace;
            line-height: 1.6;
            transition: all 0.3s ease;
            color: #e6e6e6;
        }
        
        textarea:focus { 
            outline: none; 
            border-color: #d4af37;
            box-shadow: 0 0 0 3px rgba(212, 175, 55, 0.2);
            background: rgba(0, 0, 0, 0.5);
        }
        
        .btn {
            padding: 15px 30px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            text-decoration: none;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 10px;
            transition: all 0.3s ease;
            background: linear-gradient(135deg, #d4af37, #b8941f);
            color: #0d1117;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
            width: 100%;
            justify-content: center;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            filter: brightness(1.1);
        }
        
        .btn:disabled { 
            background: rgba(212, 175, 55, 0.3); 
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .generation-options {
            margin-bottom: 30px;
        }
        
        .option-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .option-btn {
            padding: 25px 20px;
            background: rgba(255, 255, 255, 0.05);
            border: 2px solid rgba(212, 175, 55, 0.3);
            border-radius: 12px;
            color: #e6e6e6;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
        }
        
        .option-btn:hover {
            border-color: #d4af37;
            background: rgba(212, 175, 55, 0.1);
            transform: translateY(-2px);
        }
        
        .option-btn.selected {
            border-color: #d4af37;
            background: rgba(212, 175, 55, 0.2);
        }
        
        .option-btn i {
            font-size: 2rem;
            color: #d4af37;
            margin-bottom: 10px;
        }
        
        .option-btn span {
            font-size: 1.1rem;
            font-weight: 600;
            color: #d4af37;
        }
        
        .option-btn p {
            font-size: 0.9rem;
            opacity: 0.8;
            margin: 0;
            line-height: 1.4;
        }
        
        @media (max-width: 768px) {
            .option-buttons {
                grid-template-columns: 1fr;
            }
        }
        
        .loading { 
            display: none; 
            margin: 30px 0;
            text-align: center;
        }
        
        .simple-loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
        }
        
        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid rgba(212, 175, 55, 0.2);
            border-top: 3px solid #d4af37;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Workflow Modal Overlay */
        .workflow-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            z-index: 2000;
            display: none;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .workflow-modal.show {
            display: flex;
            opacity: 1;
        }
        

        
        .workflow-window {
            background: linear-gradient(135deg, #0d1117 0%, #1a1f2e 50%, #2d1b69 100%);
            border: 2px solid #d4af37;
            border-radius: 20px;
            padding: 40px;
            max-width: 900px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            position: relative;
            transform: scale(0.9);
            transition: transform 0.3s ease;
        }
        
        .workflow-modal.show .workflow-window {
            transform: scale(1);
        }
        
        .workflow-header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .workflow-title {
            font-size: 2rem;
            color: #d4af37;
            margin-bottom: 10px;
        }
        
        .workflow-subtitle {
            color: rgba(230, 230, 230, 0.8);
            font-style: italic;
        }
        
        .agent-workflow {
            display: flex;
            flex-direction: column;
            gap: 25px;
        }
        
        .workflow-progress {
            position: absolute;
            top: 15px;
            right: 20px;
            background: rgba(0, 0, 0, 0.5);
            padding: 8px 15px;
            border-radius: 20px;
            color: #d4af37;
            font-size: 0.9rem;
        }
        
        .workflow-phase {
            background: rgba(255, 255, 255, 0.02);
            border: 1px solid rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            padding: 20px;
            opacity: 0.3;
            transition: all 0.5s ease;
        }
        
        .workflow-phase.active {
            opacity: 1;
            background: rgba(212, 175, 55, 0.05);
            border-color: rgba(212, 175, 55, 0.3);
        }
        
        .workflow-phase h3 {
            color: #d4af37;
            font-size: 1rem;
            margin-bottom: 15px;
            text-align: center;
        }
        
        .phase-steps {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
        }
        
        .phase-separator {
            text-align: center;
            color: rgba(212, 175, 55, 0.5);
            font-size: 1.5rem;
            font-weight: bold;
            transition: all 0.3s ease;
        }
        
        .phase-separator.active {
            color: #d4af37;
        }
        
        .workflow-step {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 15px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            min-width: 140px;
            transition: all 0.3s ease;
            opacity: 0.3;
        }
        
        .workflow-step.active {
            opacity: 1;
            background: rgba(212, 175, 55, 0.1);
            border-color: #d4af37;
            transform: scale(1.05);
        }
        
        .workflow-step.completed {
            opacity: 0.7;
            background: rgba(34, 197, 94, 0.1);
            border-color: rgba(34, 197, 94, 0.3);
        }
        
        .step-icon {
            width: 40px;
            height: 40px;
            background: rgba(212, 175, 55, 0.2);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #d4af37;
            font-size: 1.2rem;
            margin-bottom: 8px;
            transition: all 0.3s ease;
        }
        
        .workflow-step.active .step-icon {
            background: #d4af37;
            color: #0d1117;
        }
        
        .workflow-step.completed .step-icon {
            background: #22c55e;
            color: white;
        }
        
        .step-content h4 {
            color: #e6e6e6;
            font-size: 0.9rem;
            font-weight: 600;
            margin-bottom: 4px;
            text-align: center;
        }
        
        .step-content p {
            color: rgba(230, 230, 230, 0.7);
            font-size: 0.75rem;
            text-align: center;
            line-height: 1.2;
        }
        
        .workflow-arrow {
            color: rgba(212, 175, 55, 0.5);
            font-size: 1.5rem;
            font-weight: bold;
            transition: all 0.3s ease;
        }
        
        .workflow-arrow.active {
            color: #d4af37;
        }
        
        @media (max-width: 768px) {
            .agent-workflow {
                flex-direction: column;
            }
            
            .workflow-arrow {
                transform: rotate(90deg);
                font-size: 1.2rem;
            }
        }
        
        .result { 
            margin-top: 30px; 
            padding: 25px; 
            border-radius: 12px; 
            display: none; 
        }
        
        .success { 
            background: #f0fff4; 
            border: 2px solid #9ae6b4; 
            color: #22543d; 
        }
        
        .error { 
            background: #fed7d7; 
            border: 2px solid #feb2b2; 
            color: #742a2a; 
        }
        
        .download-links { 
            margin-top: 20px; 
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }
        
        .download-links a { 
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 12px 20px; 
            background: #48bb78; 
            color: white; 
            text-decoration: none; 
            border-radius: 8px;
            font-weight: 500;
            transition: all 0.3s ease;
        }
        
        .download-links a:hover { 
            background: #38a169;
            transform: translateY(-2px);
        }
        
        .examples { 
            background: rgba(0, 0, 0, 0.2); 
            border: 1px solid rgba(212, 175, 55, 0.2);
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 30px;
            transition: all 0.3s ease;
        }
        
        .examples:hover {
            border-color: #d4af37;
            background: rgba(212, 175, 55, 0.1);
        }
        
        .examples h3 { 
            margin-bottom: 15px; 
            color: #d4af37;
            font-size: 1.2rem;
            font-weight: 600;
        }
        
        .examples ul { 
            list-style: none;
        }
        
        .examples li { 
            margin-bottom: 8px; 
            color: rgba(230, 230, 230, 0.8); 
            font-size: 0.9rem;
            padding-left: 20px;
            position: relative;
        }
        
        .examples li::before {
            content: 'â€¢';
            color: #d4af37;
            font-weight: bold;
            position: absolute;
            left: 0;
        }
        
        .quick-templates {
            margin-bottom: 30px;
        }
        
        .quick-templates h3 {
            margin-bottom: 15px;
            color: #d4af37;
            font-size: 1.2rem;
            font-weight: 600;
        }
        
        .template-btn {
            display: block;
            width: 100%;
            padding: 12px 15px;
            margin-bottom: 10px;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(212, 175, 55, 0.3);
            border-radius: 8px;
            color: rgba(230, 230, 230, 0.8);
            text-decoration: none;
            font-size: 0.9rem;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .template-btn:hover {
            background: rgba(212, 175, 55, 0.2);
            color: #d4af37;
            border-color: #d4af37;
            transform: translateY(-1px);
        }
        
        .ai-status {
            background: linear-gradient(135deg, #d4af37, #b8941f);
            color: #0d1117;
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 30px;
            text-align: center;
            box-shadow: 0 8px 25px rgba(212, 175, 55, 0.3);
            transition: all 0.3s ease;
        }
        
        .ai-status:hover {
            transform: translateY(-2px);
        }
        
        .ai-status h3 {
            margin-bottom: 10px;
            font-size: 1.1rem;
        }
        
        .ai-status p {
            font-size: 0.9rem;
            opacity: 0.9;
        }
        
        @media (max-width: 768px) {
            .container {
                grid-template-columns: 1fr;
                gap: 20px;
                margin: 20px auto;
            }
            
            .main-content, .sidebar {
                padding: 25px;
            }
            
            .page-title {
                font-size: 2rem;
            }
        }
    </style>
</head>
<body>
    <nav class="navbar">
        <div class="nav-container">
            <div class="logo">
                <img src="https://lh3.googleusercontent.com/d/1LBhx-x_Si1-cmGqsRAVmheoz0tXvJ3UN" alt="HITK Logo">
                <img src="https://lh3.googleusercontent.com/d/1gKfAWyddOwKCGFVO69ZRUh3du4E8CX9l" alt="Timely Logo">
                Timely<sup style="font-size: 0.5em;">â„¢</sup>
            </div>
            <div class="nav-links">
                <a href="/dashboard">Dashboard</a>
                <a href="/logout">Logout</a>
            </div>
        </div>
    </nav>

    <div class="container">
        <div class="main-content">
            <h1 class="page-title">AI Timetable Generator</h1>
            <p class="page-subtitle">Create intelligent timetables using natural language constraints</p>
            
            <div class="generation-options">
                <h3 style="color: #d4af37; margin-bottom: 20px;">Choose Generation Method</h3>
                
                <div class="option-buttons">
                    <button class="option-btn" id="dbRouteBtn" onclick="selectOption('db')">
                        <i class="fas fa-database"></i>
                        <span>Generate Routine from DB</span>
                        <p>Use pre-configured database with subjects, teachers, and constraints</p>
                    </button>
                    
                    <button class="option-btn" id="customRouteBtn" onclick="selectOption('custom')">
                        <i class="fas fa-edit"></i>
                        <span>Generate Routine from Custom Input</span>
                        <p>Enter natural language constraints manually</p>
                    </button>
                </div>
            </div>
            
            <form id="timetableForm" style="display: none;">
                <div class="form-group">
                    <label for="constraints">Natural Language Constraints:</label>
                    <textarea id="constraints" placeholder="Enter your timetable constraints in natural language, one per line...

Example:
Prof. Sharma is only available on Mon S1,S2, Tue S1
Math taught by Prof. Sharma needs 2 periods
Sci taught by Prof. Rao needs 2 periods
Eng taught by Prof. Iyer needs 2 periods
Prefer Math on Mon:S1, Tue:S1"></textarea>
                </div>
                
                <button type="submit" class="btn" id="generateBtn">
                    <i class="fas fa-magic"></i>
                    Generate Timetable
                </button>
            </form>
            
            <div id="dbGenerationForm" style="display: none;">
                <div style="margin-bottom: 20px; padding: 15px; background: rgba(212, 175, 55, 0.1); border-radius: 8px; border-left: 4px solid #d4af37;">
                    <h4 style="color: #d4af37; margin-bottom: 10px;"><i class="fas fa-info-circle"></i> Database Generation</h4>
                    <p style="margin: 0; font-size: 0.9rem; opacity: 0.9;">This will use the pre-configured database with subjects, teachers, rooms, and constraints to generate comprehensive timetables for all sections and semesters.</p>
                </div>
                <button class="btn" id="generateFromDbBtn">
                    <i class="fas fa-database"></i>
                    Generate from Database
                </button>
            </div>
            
            <div class="loading" id="loading">
                <div class="simple-loading">
                    <div class="spinner"></div>
                    <p>AI Agents Processing...</p>
                </div>
            </div>
            
            <div class="result" id="result"></div>
        </div>
        
        <div class="sidebar">
            <div class="ai-status">
                <h3><i class="fas fa-robot"></i> Multi-Agent System</h3>
                <p>5 AI agents collaborating to create your perfect timetable</p>
            </div>
            
            <div class="quick-templates" id="quickTemplates" style="display: none;">
                <h3>Quick Templates</h3>
                <button class="template-btn" onclick="loadTemplate('basic')">
                    <i class="fas fa-clock"></i> Basic Schedule
                </button>
                <button class="template-btn" onclick="loadTemplate('complex')">
                    <i class="fas fa-cogs"></i> Complex Constraints
                </button>
                <button class="template-btn" onclick="loadTemplate('preferences')">
                    <i class="fas fa-heart"></i> With Preferences
                </button>
            </div>
            
            <div class="examples">
                <h3><i class="fas fa-lightbulb"></i> Constraint Examples</h3>
                <ul>
                    <li>Prof. [Name] is only available on [Day] [Slots]</li>
                    <li>[Subject] taught by Prof. [Name] needs [X] periods</li>
                    <li>Prefer [Subject] on [Day]:[Slot]</li>
                    <li>No classes after 3 PM</li>
                    <li>Math and Science should not be consecutive</li>
                    <li>Prof. [Name] prefers morning slots</li>
                    <li>Maximum 2 periods per day for [Subject]</li>
                </ul>
            </div>
        </div>
    </div>
    
    <!-- Workflow Modal -->
    <div class="workflow-modal" id="workflowModal">
        <div class="workflow-window">
            <div class="workflow-progress" id="workflowProgress">Step 1 of 8</div>
            
            <div class="workflow-header">
                <h2 class="workflow-title">Multi-Agent AI Processing</h2>
                <p class="workflow-subtitle">Watch as 5 specialized AI agents collaborate to create your timetable</p>
            </div>
            
            <div class="agent-workflow">
                <div class="workflow-phase" id="phase1">
                    <h3><i class="fas fa-language"></i> Natural Language Processing</h3>
                    <div class="phase-steps">
                        <div class="workflow-step" id="step1">
                            <div class="step-icon"><i class="fas fa-brain"></i></div>
                            <div class="step-content">
                                <h4>Gemini NLP Parser</h4>
                                <p>Tokenizing natural language and analyzing syntax using Google's Gemini AI</p>
                            </div>
                        </div>
                        <div class="workflow-arrow">â†’</div>
                        <div class="workflow-step" id="step2">
                            <div class="step-icon"><i class="fas fa-search"></i></div>
                            <div class="step-content">
                                <h4>Entity Extractor</h4>
                                <p>Identifying professors, subjects, time slots, and availability constraints</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="workflow-phase" id="phase2">
                    <h3><i class="fas fa-cogs"></i> Constraint Processing</h3>
                    <div class="phase-steps">
                        <div class="workflow-step" id="step3">
                            <div class="step-icon"><i class="fas fa-filter"></i></div>
                            <div class="step-content">
                                <h4>Constraint Builder</h4>
                                <p>Converting to formal ConstraintPackage objects with hard/soft constraints</p>
                            </div>
                        </div>
                        <div class="workflow-arrow">â†’</div>
                        <div class="workflow-step" id="step4">
                            <div class="step-icon"><i class="fas fa-puzzle-piece"></i></div>
                            <div class="step-content">
                                <h4>Google OR-Tools CSP</h4>
                                <p>Finding mathematically feasible solutions using constraint programming</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="workflow-phase" id="phase3">
                    <h3><i class="fas fa-magic"></i> Optimization & Validation</h3>
                    <div class="phase-steps">
                        <div class="workflow-step" id="step5">
                            <div class="step-icon"><i class="fas fa-chart-line"></i></div>
                            <div class="step-content">
                                <h4>Quality Optimizer</h4>
                                <p>Scoring and selecting the highest quality schedule from feasible solutions</p>
                            </div>
                        </div>
                        <div class="workflow-arrow">â†’</div>
                        <div class="workflow-step" id="step6">
                            <div class="step-icon"><i class="fas fa-shield-check"></i></div>
                            <div class="step-content">
                                <h4>Semantic Verifier</h4>
                                <p>AI-powered validation of logical consistency and constraint satisfaction</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="workflow-phase" id="phase4">
                    <h3><i class="fas fa-file-export"></i> Output Generation</h3>
                    <div class="phase-steps">
                        <div class="workflow-step" id="step7">
                            <div class="step-icon"><i class="fas fa-table"></i></div>
                            <div class="step-content">
                                <h4>Grid Formatter</h4>
                                <p>Structuring timetable data into organized grid layout format</p>
                            </div>
                        </div>
                        <div class="workflow-arrow">â†’</div>
                        <div class="workflow-step" id="step8">
                            <div class="step-icon"><i class="fas fa-file-pdf"></i></div>
                            <div class="step-content">
                                <h4>PDF Generator</h4>
                                <p>Creating professional PDF documents and JSON output files</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const templates = {
            basic: `Prof. Sharma is only available on Mon S1,S2, Tue S1
Math taught by Prof. Sharma needs 2 periods
Sci taught by Prof. Rao needs 2 periods
Eng taught by Prof. Iyer needs 2 periods`,
            
            complex: `Prof. Sharma is only available on Mon S1,S2, Tue S1,S2, Wed S1
Prof. Rao is only available on Mon S2,S3, Tue S2,S3, Wed S2,S3
Prof. Iyer is only available on all days except Wed S3
Math taught by Prof. Sharma needs 3 periods
Sci taught by Prof. Rao needs 3 periods
Eng taught by Prof. Iyer needs 3 periods
Maximum 2 periods per day for any subject
No back-to-back periods for same subject`,
            
            preferences: `Prof. Sharma is only available on Mon S1,S2, Tue S1
Math taught by Prof. Sharma needs 2 periods
Sci taught by Prof. Rao needs 2 periods
Eng taught by Prof. Iyer needs 2 periods
Prefer Math on Mon:S1, Tue:S1
Prefer Sci on Mon:S2
Prof. Rao prefers afternoon slots
Avoid scheduling Math after lunch`
        };

        let selectedOption = null;
        
        async function startRoutine5App() {
            try {
                // Try to start the Routine5 app
                await fetch('/start_routine5_app', { method: 'POST' });
                // Wait a moment for the app to start
                setTimeout(() => {
                    window.location.href = 'http://127.0.0.1:7777';
                }, 3000);
            } catch (error) {
                // If starting fails, try direct redirect anyway
                window.location.href = 'http://127.0.0.1:7777';
            }
        }
        
        function selectOption(option) {
            selectedOption = option;
            
            // Update button states
            document.getElementById('dbRouteBtn').classList.remove('selected');
            document.getElementById('customRouteBtn').classList.remove('selected');
            
            if (option === 'db') {
                document.getElementById('dbRouteBtn').classList.add('selected');
                document.getElementById('timetableForm').style.display = 'none';
                document.getElementById('dbGenerationForm').style.display = 'block';
                document.getElementById('quickTemplates').style.display = 'none';
                
                // Check database status
                checkDatabaseStatus();
            } else {
                // Start Routine5 app and redirect
                startRoutine5App();
            }
        }
        
        async function checkDatabaseStatus() {
            try {
                const response = await fetch('/api/check_db_status');
                const status = await response.json();
                
                const generateBtn = document.getElementById('generateFromDbBtn');
                if (status.configured) {
                    generateBtn.innerHTML = `<i class="fas fa-database"></i> Generate from Database (${status.sections} sections, ${status.subjects} subjects)`;
                    generateBtn.disabled = false;
                } else {
                    generateBtn.innerHTML = `<i class="fas fa-exclamation-triangle"></i> Database Not Configured`;
                    generateBtn.disabled = true;
                }
            } catch (error) {
                console.error('Error checking database status:', error);
            }
        }
        
        function loadTemplate(type) {
            document.getElementById('constraints').value = templates[type];
            
            // Visual feedback
            event.target.style.background = '#48bb78';
            event.target.style.color = 'white';
            setTimeout(() => {
                event.target.style.background = '';
                event.target.style.color = '';
            }, 300);
        }

        // Handle custom form submission
        document.getElementById('timetableForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const constraints = document.getElementById('constraints').value.trim();
            if (!constraints) {
                alert('Please enter some constraints');
                return;
            }
            
            await generateTimetable('custom', { constraints: constraints });
        });
        
        // Handle DB generation
        document.getElementById('generateFromDbBtn').addEventListener('click', async function(e) {
            e.preventDefault();
            await generateTimetable('db', {});
        });
        
        async function generateTimetable(type, data) {
            const generateBtn = type === 'custom' ? document.getElementById('generateBtn') : document.getElementById('generateFromDbBtn');
            const loading = document.getElementById('loading');
            const result = document.getElementById('result');
            
            // Show loading state
            generateBtn.disabled = true;
            generateBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing...';
            loading.style.display = 'block';
            result.style.display = 'none';
            
            // Show workflow modal
            showWorkflowModal();
            
            try {
                const endpoint = type === 'custom' ? '/generate' : '/generate_from_db';
                const response = await fetch(endpoint, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(data)
                });
                
                const responseData = await response.json();
                
                // Wait for workflow to complete before showing results
                function showResults() {
                    if (workflowCompleted) {
                        if (responseData.success) {
                            result.className = 'result success';
                            if (type === 'custom') {
                                result.innerHTML = `
                                    <h3><i class="fas fa-check-circle"></i> ${responseData.message}</h3>
                                    <div class="download-links">
                                        <a href="/download/timetable.pdf" target="_blank">
                                            <i class="fas fa-file-pdf"></i> Download PDF
                                        </a>
                                        <a href="/download/timetable.json" target="_blank">
                                            <i class="fas fa-code"></i> Download JSON
                                        </a>
                                    </div>
                                    ${responseData.verification && responseData.verification.warnings && responseData.verification.warnings.length > 0 ? 
                                        `<div style="margin-top: 15px; padding: 15px; background: rgba(255, 193, 7, 0.1); border-radius: 8px; border-left: 4px solid #ffc107;">
                                            <strong><i class="fas fa-exclamation-triangle"></i> Warnings:</strong><br>
                                            ${responseData.verification.warnings.map(w => `â€¢ ${w}`).join('<br>')}
                                        </div>` : ''}
                                `;
                            } else {
                                result.innerHTML = `
                                    <h3><i class="fas fa-check-circle"></i> Timetables generated successfully!</h3>
                                    <div class="download-links">
                                        <a href="/download_routine5_schedules" target="_blank">
                                            <i class="fas fa-file-pdf"></i> Download All Timetables PDF
                                        </a>
                                    </div>
                                `;
                            }
                        } else {
                            result.className = 'result error';
                            result.innerHTML = `
                                <h3><i class="fas fa-exclamation-circle"></i> Error</h3>
                                <p>${responseData.error}</p>
                            `;
                        }
                        
                        generateBtn.disabled = false;
                        generateBtn.innerHTML = type === 'custom' ? '<i class="fas fa-magic"></i> Generate Timetable' : '<i class="fas fa-database"></i> Generate from Database';
                        loading.style.display = 'none';
                        result.style.display = 'block';
                    } else {
                        setTimeout(showResults, 500);
                    }
                }
                
                showResults();
                
            } catch (error) {
                result.className = 'result error';
                result.innerHTML = `
                    <h3><i class="fas fa-exclamation-circle"></i> Error</h3>
                    <p>Failed to generate timetable: ${error.message}</p>
                `;
                
                generateBtn.disabled = false;
                generateBtn.innerHTML = type === 'custom' ? '<i class="fas fa-magic"></i> Generate Timetable' : '<i class="fas fa-database"></i> Generate from Database';
                loading.style.display = 'none';
                result.style.display = 'block';
            }
        }

        document.getElementById('timetableForm').addEventListener('submit', async function(e) {
            // This is now handled by the generateTimetable function above
        });
        
        let workflowCompleted = false;
        
        function showWorkflowModal() {
            const modal = document.getElementById('workflowModal');
            modal.classList.add('show');
            startAgentWorkflow();
        }
        
        function hideWorkflowModal() {
            const modal = document.getElementById('workflowModal');
            modal.classList.remove('show');
        }
        
        function startAgentWorkflow() {
            const phases = ['phase1', 'phase2', 'phase3', 'phase4'];
            const steps = ['step1', 'step2', 'step3', 'step4', 'step5', 'step6', 'step7', 'step8'];
            const progressEl = document.getElementById('workflowProgress');
            let currentPhase = 0;
            let currentStepGlobal = 0;
            workflowCompleted = false;
            
            // Reset all phases and steps
            phases.forEach(phaseId => {
                const phase = document.getElementById(phaseId);
                phase.classList.remove('active', 'completed');
            });
            steps.forEach(stepId => {
                const step = document.getElementById(stepId);
                step.classList.remove('active', 'completed');
            });
            
            function animatePhase() {
                if (currentPhase < phases.length) {
                    const phaseEl = document.getElementById(phases[currentPhase]);
                    phaseEl.classList.add('active');
                    
                    const phaseSteps = currentPhase === 0 ? [0, 1] : 
                                     currentPhase === 1 ? [2, 3] :
                                     currentPhase === 2 ? [4, 5] : [6, 7];
                    
                    animateStepsInPhase(phaseSteps, () => {
                        phaseEl.classList.remove('active');
                        phaseEl.classList.add('completed');
                        currentPhase++;
                        setTimeout(animatePhase, 800);
                    });
                } else {
                    workflowCompleted = true;
                    setTimeout(() => {
                        hideWorkflowModal();
                    }, 1500);
                }
            }
            
            function animateStepsInPhase(stepIndices, callback) {
                let stepIndex = 0;
                
                function animateNextStep() {
                    if (stepIndex < stepIndices.length) {
                        const stepEl = document.getElementById(steps[stepIndices[stepIndex]]);
                        stepEl.classList.add('active');
                        
                        currentStepGlobal++;
                        progressEl.textContent = `Step ${currentStepGlobal} of 8`;
                        
                        setTimeout(() => {
                            stepEl.classList.remove('active');
                            stepEl.classList.add('completed');
                            stepIndex++;
                            setTimeout(animateNextStep, 600);
                        }, 2000);
                    } else {
                        callback();
                    }
                }
                
                animateNextStep();
            }
            
            setTimeout(animatePhase, 1000);
        }
    </script>
</body>
</html>